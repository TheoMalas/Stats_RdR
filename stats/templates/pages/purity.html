{% extends "base.html" %}

{% block title %} {{ molecule_name }} {% endblock %}
{% block centerText %} Statistiques sur la pureté de {{ molecule_name }} {% endblock %}

{% block body %}

<div class="d-flex align-items-center gap-3 m-3">
    
    <!-- Infos sur le nombre total d'observations -->
    <div>
        <p class="display-6 mb-0">{{ data_count }}</p>
        <small>Nombre total d'échantillons observés</small>
    </div>

    <!-- Bouton pour ouvrir le formulaire -->
    <button class="btn btn-primary flex-shrink-0" style="width: 200px;" 
            type="button" data-bs-toggle="offcanvas" data-bs-target="#formOffcanvas" 
            aria-controls="formOffcanvas">
        Ouvrir le formulaire
    </button>
</div>

<!-- Offcanvas gauche -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="formOffcanvas" aria-labelledby="formOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="formOffcanvasLabel">Formulaire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
    </div>
    <div class="offcanvas-body">
        {% include "components/form_date.html" %}
    </div>
</div>

<div class="container py-3">
    <div class="masonry-grid">

        <!-- Carte 1 : Histogramme de pureté -->
        <div class="card text-center">
            <div class="card-header">
                Distribution de la pureté
            </div>
            <div class="card-body">
                {% include "components/bar_y_chart.html" with id="bar_chart" chart_data=data %}
                <p>Commençons par regarder l'histogramme de la pureté des échantillons analysés.</p>
            </div>
        </div>

        <!-- Carte 2 : Évolution temporelle -->
        <div class="card text-center">
            <div class="card-header">
                Évolution temporelle de la pureté
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="chart1-tab" data-bs-toggle="tab" data-bs-target="#chart1" type="button" role="tab">
                            Moyenne et écarts type
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chart2-tab" data-bs-toggle="tab" data-bs-target="#chart2" type="button" role="tab">
                            Médianes et quartiles
                        </button>
                    </li>
                </ul>
                <div class="tab-content mt-3">
                    <div class="tab-pane fade show active" id="chart1" role="tabpanel">
                        <p>Ligne centrale : moyenne, inférieure : moyenne - 1 écart-type, supérieure : moyenne + 1 écart-type.</p>
                        {% include "components/line_chart.html" with id="line_1" chart_data=data is_stacked='false' %}
                    </div>
                    <div class="tab-pane fade" id="chart2" role="tabpanel">
                        <p>Ligne centrale : médiane, inférieure : 1er quartile, supérieure : 3e quartile.</p>
                        {% include "components/line_chart.html" with id="line_2" chart_data=data_2 is_stacked='false' %}
                    </div>
                </div>
                <p>
                    Jetons ensuite un coup d'œil à l'évolution temporelle de la pureté. Deux choix s'offrent à vous, vous pouvez soit visualiser
                    l'évolution de la moyenne et de l'écart-type de la distribution des échantillons, soit l'évolution de la médiane,
                    ainsi que le premier et troisième quartile. Chacune des grandeurs est calculées sur une fenêtre glissante de Δ
                    jours autour de chaque échantillon reçu.
                </p>
            </div>
        </div>
        
        {% if regression_data %}
        <!-- Carte 3 : Régression par mode d'approvisionnement -->
        <div class="card text-center">
            <div class="card-header">
                Influence du mode d'approvisionnement
            </div>
            <div class="card-body">
                {% include "components/regression_table.html" with id="supply_regression" table_data=regression_data %}
                 <p>
                Intéressons-nous ensuite à la dépendance de la pureté au mode d'approvisionnement. Pour cela, nous régressons
                la pureté sur le mode d'approvisionnement. Pour ce faire, on choisi le mode d'approvisionnement privilégié (Deep web / dark web)
                et on regarde si l'écart à ce premier mode est statistiquement significatif. Cette significativité est symbolisée 
                par les "*" dans la colonne écart. "***" si la probabilité que l'écart soit simplement dû au hasard est plus petite
                que 1%, "**" si elle est plus petite que 5% et "*" si cette probabilité est plus petite que 10%. Cette probabilité
                se nomme la <a href="https://fr.wikipedia.org/wiki/Valeur_p" target="_blank">p-value</a>.
                <br>
                On peut aussi, de façon plus approximative, comparer
                l'<a href="https://fr.wikipedia.org/wiki/Erreur_type" target="_blank"> erreur standard</a> à son coefficient respectif, si l'écart est moins que le double de l'erreur standard, alors
                on ne peut pas détecté si l'écart observé est dû au hasard ou non. 
                <br>
                Enfin, nous présentons aussi le coefficient R² qui permet de quantifier à quel point le modèle de régression
                permet d'expliquer les données observés. Ce coefficient est compris entre 0 et 1 : plus le R² est élevé,
                mieux il explique les données. 
                Pour de plus amples informations, voir <a href="https://fr.wikipedia.org/wiki/Coefficient_de_d%C3%A9termination" target="_blank">ici</a>.
            </p>
            </div>
        </div>
        {% endif %}

        {% if molecule_name == "Héroïne" %}
        <!-- Carte 4 : Cas particulier héroïne -->
        <div class="card text-center">
            <div class="card-header">
                Pureté après première consommation
            </div>
            <div class="card-body">
                <p>Pour l'héroïne, les échantillons envoyés après première consommation présentent un écart significatif.</p>
                {% include "components/regression_table.html" with id="conso_regression" table_data=regression_data_consommation %}
            </div>
        </div>
        {% endif %}

        {% if map_data_color %}
        <!-- Carte 5 : Carte de la pureté par région -->
        <div class="card text-center">
            <div class="card-header">
                Pureté moyenne par région
            </div>
            <div class="card-body">
                {% include "components/map.html" with id="map_chart" chart_data=map_data color_data=map_data_color %}
                <p>
                    Enfin, regardons la géographie de la pureté. Sur la carte suivante est présentée la pureté moyenne
                    par région.
                </p>
            </div>
        </div>
        {% endif %}

        {% if reg_map_data %}
        <!-- Carte 6 : Analyse de la carte de la pureté -->
        <div class="card text-center">
            <div class="card-header">
                Analyse de la carte de la pureté
            </div>
            <div class="card-body">
                {% include "components/regression_table_fe.html" with id="region_regression" table_data=reg_map_data %}
                <p>
                    Demandons-nous comment analyser la carte de France présentant la pureté par région. Pour certaines
                    molécules, on peut remarquer de fortes différences de couleurs, et ainsi de pureté moyenne, entre
                    les différentes régions. Cependant, l'image est incomplète : les différences pourraient très bien être
                    dues à différents modes d'approvisionnement ou bien à différentes dates d'achat. Pour prendre cela en compte,
                    nous réalisons une <a href="https://en.wikipedia.org/wiki/Fixed_effects_model"  target="_blank">régression à effets fixes</a>
                    en choisissant comme effets fixes le mode d'approvisionnement et le bimestre d'achat. Concrètement, cela revient à comparer
                    uniquement les variations de qualité à l’intérieur d’un même mode d’approvisionnement et d’un même bimestre, en
                    neutralisant les différences moyennes entre groupes. De cette façon, on isole l’effet des autres variables 
                    (comme la région) indépendamment de ces facteurs fixes.
                    <br>
                    Pour créer ce tableau, nous devons choisir une région à laquelle comparée toutes les autres; nous avons choisi
                    de prendre la région d'où provient la majorité des échantillons, soit l’Île-de-France. Le tableau se lit par exmple de la façon suivante :
                    pour un même mode d’approvisionnement et un même bimestre, la pureté moyenne des échantillons provenant du <i>Grand-Est</i> est en moyenne
                    à un certain <i>écart</i>. Chaque écart est caractérisée par sa <a href="https://fr.wikipedia.org/wiki/Valeur_p" target="_blank">p-value</a>
                    (les potentielles astérisques) et par son <a href="https://fr.wikipedia.org/wiki/Erreur_type" target="_blank"> erreur standard</a>.
                    <br>
                    Il se peut que pour une ou plusieurs régions, Le modèle ne puisse pas estimer un coefficient parce que la pureté de tous les échantillons
                    sont déjà parfaitement déterminés par la combinaison des efferts fixes. Les échantillons provenant de cette région,
                    (voire ces régions) ont tous une commbinaison <i>mode d'approvisionnement</i> x <i>bimestre</i> différente.
                </p>
            </div>
        </div>
        {% endif %}

        {% if molecule_name == "MDMA_tablets" %}
        <!-- MDMA comprime scatter-and-line plot -->
        <div class="card text-center">
            <div class="card-header">
                Quantité de MDMA VS Masse des comprimés
            </div>
            <div class="card-body">
                {% include "components/scatter_line_chart.html" with id="scatter_mdma_comprime" chart_data=data_reg_dose_poids %}
            </div>
        </div>

        <!-- MDMA quantity estimator -->
        <div class="card text-center">
            <div class="card-header">
                Estimation de la quantité de MDMA
            </div>
            <div class="card-body">
                {% include "components/MDMA_calculator.html" with id="mdma_calculator" data=data_reg_dose_poids %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.masonry-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(600px, 1fr));
    gap: 1.5rem;
}
.card {
    min-height: 100%;
    display: flex;
    flex-direction: column;
}
.card-body {
    display: flex;
    flex-direction: column;
}
.card-header {
    font-weight: bold;
}
</style>

<script>
document.addEventListener('shown.bs.tab', function (event) {
    setTimeout(() => {
        if (window.line_1_chart && event.target.id === 'chart1-tab') {
            window.line_1_chart.resize();
        } else if (window.line_2_chart && event.target.id === 'chart2-tab') {
            window.line_2_chart.resize();
        }
    }, 100);
});
</script>

{% endblock %}
