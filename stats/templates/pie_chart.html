<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Diagramme en camembert</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        canvas {
            border: 1px solid #dee2e6;
            width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h2 class="text-center mb-5">Répartition des molécules</h2>
        <div class="row g-4">
            <!-- Colonne gauche : Formulaire -->
            <div class="col-md-5">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Remplir le formulaire</h5>
                    </div>
                    <div class="card-body">
                        <div>

                            <div class="mb-3">
                                <label for="nom" class="form-label">Choisir une date de début :</label>
                                <input type="date" class="form-control" id="date_debut">
                            </div>

                            <div class="mb-3">
                                <label for="nom" class="form-label">Choisir une date de fin :</label>
                                <input type="date" class="form-control" id="date_fin">
                            </div>
                           
                            <div class="mb-1">
                                <label for="nom" class="form-label">Cathinones</label>
                                <input type="checkbox" name="famille" value="Cathinones"> 
                            </div>

                            <div class="mb-1">
                                <label for="nom" class="form-label">MDMA</label>
                                <input type="checkbox" name="famille" value="MDMA"> 
                            </div>
                            <div class="mb-1">
                                <label for="nom" class="form-label">Cocaïne</label>
                                <input type="checkbox" name="famille" value="Cocaïne"> 
                            </div>

                            <div class="mb-1">
                                <label for="nom" class="form-label">Dissociatifs</label>
                                <input type="checkbox" name="famille" value="Dissociatifs">
                            </div>
                            <div class="mb-1">
                                <label for="nom" class="form-label">Amphétamines</label>
                                <input type="checkbox" name="famille" value="Amphétamines">
                            </div>

                            <div class="mb-1">
                                <label for="nom" class="form-label">Opioïdes</label>
                                <input type="checkbox" name="famille" value="Opioïdes"> 
                            </div>
                            <div class="mb-1">
                                <label for="nom" class="form-label">Cannabinoïdes</label>
                                <input type="checkbox" name="famille" value="Cannabinoïdes"> 
                            </div>

                            <div class="mb-1">
                                <label for="nom" class="form-label">Hallucinogènes</label>
                                <input type="checkbox" name="famille" value="Hallucinogènes">
                            </div>

                            <div class="mb-1">
                                <label for="nom" class="form-label">Crack/Freebase (cocaine base)</label>
                                <input type="checkbox" name="famille" value="Crack/Freebase (cocaine base)">
                            </div>

                            <div class="mb-1">
                                <label for="nom" class="form-label">Benzodiazépines_et_similaires</label>
                                <input type="checkbox" name="famille" value="Benzodiazépines_et_similaires">
                            </div>

                            <div class="mb-1">
                                <label for="nom" class="form-label">GABAergiques_non_benzo</label>
                                <input type="checkbox" name="famille" value="GABAergiques_non_benzo">
                            </div>

                            <button onclick="loadChart()" class="btn btn-primary w-100">Envoyer</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Colonne droite : Canvas -->
            <div class="col-md-7">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Aperçu sur le Canvas</h5>
                    </div>
                    <div class="card-body text-center">
                        <canvas id="myPieChart" width="400" height="400"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let pieChart = null;

        function loadChart() {
            const date_debut = document.getElementById('date_debut').value;
            const date_fin = document.getElementById('date_fin').value;
            //const url = `/chart-data/?date_debut=${encodeURIComponent(date_debut)}&date_fin=${encodeURIComponent(date_fin)}`;
            const selectedFamilles = Array.from(document.querySelectorAll('input[name="famille"]:checked'))
                                     .map(cb => cb.value);
            const params = new URLSearchParams();
            if (date_debut) params.append('date_debut', date_debut);
            if (date_fin) params.append('date_fin', date_fin);
            if (selectedFamilles.length > 0) params.append('familles', selectedFamilles.join(','));
            
            const url = '/chart-data/' + (params.toString() ? '?' + params.toString() : '');
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('myPieChart').getContext('2d');

                    if (pieChart) {
                        pieChart.destroy(); // détruire l'ancien graphique s'il existe
                    }

                    pieChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: Array.isArray(data.labels) ? data.labels : [ data.labels ],
                            datasets: [{
                                data: Array.isArray(data.data) ? data.data : [ data.data ],
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                            }]
                        },
                    });
                });
        }

        // Optionnel : charger un graphique par défaut à l'ouverture
        window.onload = loadChart;
    </script>
</body>
</html>